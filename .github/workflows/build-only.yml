name: Build Only (No Deploy)

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'
  JAVA_VERSION: '21'

jobs:
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with flake8 (optional)
        working-directory: ./backend
        run: |
          pip install flake8
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true
        continue-on-error: true

      - name: Test Docker build
        working-directory: ./backend
        run: |
          docker build -t ai-goal-tracker-backend:test .

      - name: Upload backend build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-build-logs
          path: |
            backend/**/*.log
          retention-days: 7
          if-no-files-found: ignore

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Install dependencies
        working-directory: ./frontend
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build React app
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:8000}
        run: npm run build

      - name: Test Docker build
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:8000}
        run: |
          docker build --build-arg REACT_APP_API_URL=${REACT_APP_API_URL:-http://localhost:8000} -t ai-goal-tracker-frontend:test .

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build/
          retention-days: 7

  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build React app
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: ${REACT_APP_API_URL:-https://your-backend.onrender.com}
        run: npm run build

      - name: Install Capacitor dependencies
        working-directory: ./frontend
        run: |
          # Install Capacitor core and Android platform
          npm install @capacitor/core @capacitor/android @capacitor/cli --save-dev
          
      - name: Initialize Capacitor (if needed)
        working-directory: ./frontend
        run: |
          # Initialize Capacitor if capacitor.config.json doesn't exist
          if [ ! -f capacitor.config.json ]; then
            npx cap init "AI Goal Tracker" "com.yourcompany.aigoaltracker" || true
          fi
          
      - name: Add Capacitor Android platform
        working-directory: ./frontend
        run: |
          # Add Android platform if it doesn't exist
          if [ ! -d "android" ]; then
            npx cap add android
          fi
          
      - name: Sync Capacitor
        working-directory: ./frontend
        run: |
          npx cap sync android
          
      - name: Configure Gradle Java version
        working-directory: ./frontend/android
        run: |
          # Ensure gradle.properties exists
          if [ ! -f gradle.properties ]; then
            touch gradle.properties
          fi
          # Set Java version for Gradle
          if ! grep -q "org.gradle.java.home" gradle.properties; then
            echo "org.gradle.java.home=$JAVA_HOME" >> gradle.properties
          fi
          # Set source and target compatibility
          echo "android.defaults.buildfeatures.buildconfig=true" >> gradle.properties || true
          
      - name: Configure app build.gradle
        working-directory: ./frontend/android/app
        run: |
          if [ -f build.gradle ]; then
            sed -i 's/sourceCompatibility JavaVersion.VERSION_[0-9]*/sourceCompatibility JavaVersion.VERSION_21/' build.gradle || true
            sed -i 's/targetCompatibility JavaVersion.VERSION_[0-9]*/targetCompatibility JavaVersion.VERSION_21/' build.gradle || true
          fi
          
      - name: Configure capacitor-android build.gradle
        working-directory: ./frontend/android
        run: |
          find . -name "build.gradle" -path "*/capacitor-android/*" -exec sed -i 's/sourceCompatibility JavaVersion.VERSION_[0-9]*/sourceCompatibility JavaVersion.VERSION_21/g' {} \; || true
          find . -name "build.gradle" -path "*/capacitor-android/*" -exec sed -i 's/targetCompatibility JavaVersion.VERSION_[0-9]*/targetCompatibility JavaVersion.VERSION_21/g' {} \; || true

      - name: Setup Android signing
        working-directory: ./frontend/android
        continue-on-error: true
        run: |
          # Create keystore for signing (for testing - use proper keystore in production)
          keytool -genkeypair -v -storetype PKCS12 -keystore app/keystore.jks \
            -alias key -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=AI Goal Tracker, OU=Mobile, O=Company, L=City, ST=State, C=US" || true

      - name: Configure signing in gradle.properties
        working-directory: ./frontend/android
        continue-on-error: true
        run: |
          if [ ! -f gradle.properties ]; then
            touch gradle.properties
          fi
          if ! grep -q "KEYSTORE_FILE" gradle.properties; then
            cat >> gradle.properties << EOF
          KEYSTORE_FILE=app/keystore.jks
          KEYSTORE_PASSWORD=android
          KEY_ALIAS=key
          KEY_PASSWORD=android
          EOF
          fi

      - name: Build APK
        working-directory: ./frontend/android
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace --info 2>&1 | tee build.log || (cat build.log && exit 1)

      - name: Find APK
        id: find_apk
        working-directory: ./frontend/android
        run: |
          APK_PATH=$(find app/build/outputs/apk -name "*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "APK not found!"
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK: $APK_PATH"
          ls -lh "$APK_PATH"

      - name: Upload APK artifact
        if: ${{ steps.find_apk.outputs.apk_path != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 30

      - name: Fail if APK missing
        if: ${{ steps.find_apk.outputs.apk_path == '' }}
        run: |
          echo "APK file was not found. Please check the build logs for errors."
          exit 1

      - name: Build AAB (optional, for Play Store)
        working-directory: ./frontend/android
        continue-on-error: true
        run: |
          ./gradlew bundleRelease || echo "AAB build failed, continuing..."

      - name: Find AAB
        id: find_aab
        working-directory: ./frontend/android
        continue-on-error: true
        run: |
          AAB_PATH=$(find app/build/outputs/bundle -name "*.aab" | head -n 1) || echo ""
          if [ -n "$AAB_PATH" ]; then
            echo "aab_path=$AAB_PATH" >> $GITHUB_OUTPUT
            echo "Found AAB: $AAB_PATH"
            ls -lh "$AAB_PATH"
          fi

      - name: Upload AAB artifact
        if: steps.find_aab.outputs.aab_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: ${{ steps.find_aab.outputs.aab_path }}
          retention-days: 30

