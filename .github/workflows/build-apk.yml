name: Build Android APK

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build React app
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || 'https://your-backend.onrender.com' }}
        run: npm run build

      - name: Install Capacitor dependencies
        working-directory: ./frontend
        run: |
          # Install Capacitor core and Android platform
          npm install @capacitor/core @capacitor/android @capacitor/cli --save-dev
          
      - name: Initialize Capacitor (if needed)
        working-directory: ./frontend
        run: |
          # Initialize Capacitor if capacitor.config.json doesn't exist
          if [ ! -f capacitor.config.json ]; then
            npx cap init "AI Goal Tracker" "com.yourcompany.aigoaltracker" || true
          fi
          
      - name: Add Capacitor Android platform
        working-directory: ./frontend
        run: |
          # Add Android platform if it doesn't exist
          if [ ! -d "android" ]; then
            npx cap add android
          fi
          
      - name: Sync Capacitor
        working-directory: ./frontend
        run: |
          npx cap sync android

      - name: Setup Android signing
        working-directory: ./frontend/android
        run: |
          # Create keystore for signing (for testing - use proper keystore in production)
          keytool -genkeypair -v -storetype PKCS12 -keystore app/keystore.jks \
            -alias key -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=AI Goal Tracker, OU=Mobile, O=Company, L=City, ST=State, C=US" || true

      - name: Configure signing in gradle.properties
        working-directory: ./frontend/android
        run: |
          cat >> gradle.properties << EOF
          KEYSTORE_FILE=app/keystore.jks
          KEYSTORE_PASSWORD=android
          KEY_ALIAS=key
          KEY_PASSWORD=android
          EOF

      - name: Build APK
        working-directory: ./frontend/android
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Find APK
        id: find_apk
        working-directory: ./frontend/android
        run: |
          APK_PATH=$(find app/build/outputs/apk -name "*.apk" | head -n 1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK: $APK_PATH"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 30

      - name: Build AAB (optional, for Play Store)
        working-directory: ./frontend/android
        continue-on-error: true
        run: |
          ./gradlew bundleRelease || echo "AAB build failed, continuing..."

      - name: Find AAB
        id: find_aab
        working-directory: ./frontend/android
        continue-on-error: true
        run: |
          AAB_PATH=$(find app/build/outputs/bundle -name "*.aab" | head -n 1) || echo ""
          if [ -n "$AAB_PATH" ]; then
            echo "aab_path=$AAB_PATH" >> $GITHUB_OUTPUT
            echo "Found AAB: $AAB_PATH"
          fi

      - name: Upload AAB artifact
        if: steps.find_aab.outputs.aab_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: ${{ steps.find_aab.outputs.aab_path }}
          retention-days: 30
