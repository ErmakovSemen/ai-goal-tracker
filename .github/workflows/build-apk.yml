name: Build Android APK

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          
      - name: Verify Java version
        run: |
          java -version
          echo "JAVA_HOME=$JAVA_HOME"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: platform-tools platforms;android-34 build-tools;34.0.0
          accept-android-sdk-licenses: true

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build React app
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL || 'https://your-backend.onrender.com' }}
        run: npm run build

      - name: Install Capacitor dependencies
        working-directory: ./frontend
        run: |
          # Install Capacitor core and Android platform (using version 4.8.2 for stability with API 34)
          npm install @capacitor/core@4.8.2 @capacitor/android@4.8.2 @capacitor/cli@4.8.2 --save-dev
          
      - name: Initialize Capacitor (if needed)
        working-directory: ./frontend
        run: |
          # Initialize Capacitor if capacitor.config.json doesn't exist
          if [ ! -f capacitor.config.json ]; then
            npx cap init "AI Goal Tracker" "com.yourcompany.aigoaltracker" || true
          fi
          
      - name: Add Capacitor Android platform
        working-directory: ./frontend
        run: |
          # Remove existing android directory to ensure clean setup
          if [ -d "android" ]; then
            rm -rf android
          fi
          npx cap add android
          
      - name: Sync Capacitor
        working-directory: ./frontend
        run: |
          npx cap sync android
          
      - name: Check app/build.gradle structure
        working-directory: ./frontend/android
        run: |
          if [ -f "app/build.gradle" ]; then
            echo "=== Full app/build.gradle file ==="
            cat app/build.gradle
            echo "=== End of file ==="
            echo "=== Line 4 specifically ==="
            sed -n '4p' app/build.gradle
            echo "=== Checking for rootProject references ==="
            grep -n "rootProject" app/build.gradle || echo "No rootProject references found"
          fi
          
      - name: Configure Gradle Java version
        working-directory: ./frontend/android
        run: |
          # Ensure gradle.properties exists
          if [ ! -f gradle.properties ]; then
            touch gradle.properties
          fi
          # Set Java version for Gradle
          if ! grep -q "org.gradle.java.home" gradle.properties; then
            echo "org.gradle.java.home=$JAVA_HOME" >> gradle.properties
          fi
          # Set source and target compatibility
          echo "android.defaults.buildfeatures.buildconfig=true" >> gradle.properties || true
          
      - name: Fix app/build.gradle rootProject references
        working-directory: ./frontend/android
        run: |
          if [ -f "app/build.gradle" ]; then
            # Create backup
            cp app/build.gradle app/build.gradle.bak
            
            # Replace rootProject.ext references with actual values
            sed -i 's/rootProject\.ext\.compileSdkVersion/34/g' app/build.gradle
            sed -i 's/rootProject\.ext\.minSdkVersion/22/g' app/build.gradle
            sed -i 's/rootProject\.ext\.targetSdkVersion/34/g' app/build.gradle
            
            # Also check root build.gradle and create ext block if needed
            if [ -f "build.gradle" ] && ! grep -q "ext {" build.gradle; then
              echo "Adding ext block to root build.gradle"
              # Add ext block after buildscript block or at the end
              if grep -q "buildscript {" build.gradle; then
                # Find the end of buildscript block and add ext after it
                awk '/^}$/ && !done {print; print ""; print "ext {"; print "    compileSdkVersion = 34"; print "    minSdkVersion = 22"; print "    targetSdkVersion = 34"; print "}"; done=1; next}1' build.gradle > build.gradle.tmp && mv build.gradle.tmp build.gradle
              else
                # Just add at the beginning using echo
                echo "ext {" > build.gradle.tmp
                echo "    compileSdkVersion = 34" >> build.gradle.tmp
                echo "    minSdkVersion = 22" >> build.gradle.tmp
                echo "    targetSdkVersion = 34" >> build.gradle.tmp
                echo "}" >> build.gradle.tmp
                cat build.gradle >> build.gradle.tmp
                mv build.gradle.tmp build.gradle
              fi
            fi
          fi

      - name: Setup Android signing
        working-directory: ./frontend/android
        run: |
          # Create keystore for signing (for testing - use proper keystore in production)
          keytool -genkeypair -v -storetype PKCS12 -keystore app/keystore.jks \
            -alias key -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=AI Goal Tracker, OU=Mobile, O=Company, L=City, ST=State, C=US" || true

      - name: Configure signing in gradle.properties
        working-directory: ./frontend/android
        run: |
          cat >> gradle.properties << EOF
          KEYSTORE_FILE=app/keystore.jks
          KEYSTORE_PASSWORD=android
          KEY_ALIAS=key
          KEY_PASSWORD=android
          EOF

      - name: Build APK
        working-directory: ./frontend/android
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace --info 2>&1 | tee build.log || (cat build.log && exit 1)

      - name: Find APK
        id: find_apk
        working-directory: ./frontend/android
        run: |
          APK_PATH=$(find app/build/outputs/apk -name "*.apk" | head -n 1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK: $APK_PATH"

      - name: Upload APK artifact
        if: ${{ steps.find_apk.outputs.apk_path != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 30

      - name: Fail if APK missing
        if: ${{ steps.find_apk.outputs.apk_path == '' }}
        run: |
          echo "APK file was not found. Please check the build logs for errors."
          exit 1

      - name: Build AAB (optional, for Play Store)
        working-directory: ./frontend/android
        continue-on-error: true
        run: |
          ./gradlew bundleRelease || echo "AAB build failed, continuing..."

      - name: Find AAB
        id: find_aab
        working-directory: ./frontend/android
        continue-on-error: true
        run: |
          AAB_PATH=$(find app/build/outputs/bundle -name "*.aab" | head -n 1) || echo ""
          if [ -n "$AAB_PATH" ]; then
            echo "aab_path=$AAB_PATH" >> $GITHUB_OUTPUT
            echo "Found AAB: $AAB_PATH"
          fi

      - name: Upload AAB artifact
        if: steps.find_aab.outputs.aab_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: ${{ steps.find_aab.outputs.aab_path }}
          retention-days: 30
