on:
  push:
    workflows:
      - build-and-deploy
      - mirror-to-github
      - build-apk
    filter:
      branches:
        - "main"

workflows:
  build-and-deploy:
    tasks:
      - name: build-backend
        cubes:
          - name: build-python-app
            image: docker.io/library/python:3.9
            script:
              - cd backend
              - pip install --upgrade pip
              - if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
              - echo "Backend build completed"
      - name: build-and-deploy-frontend
        cubes:
          - name: build-react-app
            image: docker.io/library/node:18
            script:
              - cd frontend
              - npm install
              - npm run build
              - ls -la build/
          - name: deploy-react-app
            image: docker.io/library/node:18
            needs: [build-react-app]
            script:
              - git config --global user.email "ci@sourcecraft.dev"
              - git config --global user.name "SourceCraft CI"
              - git add -f frontend/build/
              - git commit -m "Deploy site - update frontend build files" || echo "No changes to commit"
              - git push origin main
  mirror-to-github:
    tasks:
      - name: push-to-github
        cubes:
          - name: push-changes
            image: docker.io/library/alpine:latest
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            script:
              - echo ${{secrets.GITHUB_TOKEN}}
              - apk add --no-cache git
              - git init
              - git config user.email "ci@sourcecraft.dev"
              - git config user.name "SourceCraft CI"
              - git add .
              - git commit -m "Mirror from SourceCraft" || echo "No changes to commit"
              - |
                if [ -z "${GITHUB_TOKEN}" ]; then
                  echo "Error: GITHUB_TOKEN is not set"
                  exit 1
                fi
              - git remote add github https://oauth2:${GITHUB_TOKEN}@github.com/ErmakovSemen/ai-goal-tracker.git || true
              - echo "GITHUB_TOKEN is set and will be used for authentication"
              - git push github main --force
  build-apk:
    tasks:
      - name: build-apk-task
        cubes:
          - name: setup-node
            image: docker.io/library/node:18
            script:
              - cd frontend
              - npm install
              - npm run build
          - name: setup-capacitor
            needs: [setup-node]
            image: docker.io/library/node:18
            script:
              - cd frontend
              - npm install @capacitor/core @capacitor/cli @capacitor/android
              - npx cap init "AI Goal Tracker" "com.yourcompany.aigoaltracker"
          - name: build-apk
            needs: [setup-capacitor]
            image: ubuntu:20.04
            script:
              - export DEBIAN_FRONTEND=noninteractive
              - export TZ=Europe/Moscow
              - apt-get update && apt-get install -y tzdata
              - ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
              - apt-get install -y openjdk-11-jdk nodejs npm
              - export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
              - echo JAVA_HOME is set to $JAVA_HOME
              - java -version
              - pwd
              - echo Current user
              - whoami
              - echo Environment variables
              - env
              - echo Listing workspace directory
              - ls -la
              - echo Listing frontend directory
              - ls -la frontend/
              - echo Changing to frontend directory
              - cd frontend
              - echo Adding Android platform
              - npx cap add android
              - echo Copying web assets
              - npx cap copy
              - echo Listing android directory
              - ls -la android/
              - echo Changing to android directory
              - cd android
              - echo Making gradlew executable
              - chmod +x ./gradlew
              - echo Building APK with manual Java installation
              - ./gradlew assembleDebug
              - echo APK build completed
            artifacts:
              paths:
                - frontend/android/app/build/outputs/apk/debug/app-debug.apk